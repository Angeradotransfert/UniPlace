{% extends "base.html" %}

{% block content %}

<style>
  /* Styles gÃ©nÃ©raux */
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }

  /* Media Query pour les petits Ã©crans (mobile) */
  @media screen and (max-width: 768px) {
    body {
      font-size: 14px;
    }

    .menu {
      display: none; /* Par exemple, on cache le menu principal pour mobile */
    }

    .menu-mobile {
      display: block; /* On montre un menu mobile */
    }

    .header {
      text-align: center;
    }
  }

  /* Media Query pour les Ã©crans plus grands (tablette et plus) */
  @media screen and (min-width: 769px) {
    .menu {
      display: block;
    }

    .menu-mobile {
      display: none;
    }
  }
</style>

<div style="max-width: 1100px; margin: auto; padding: 40px 20px; font-family: 'Baloo 2', cursive;">
    <h2 style="text-align: center; font-size: 2.4rem; color: #2c3e50;">ğŸ“¦ {{ _('Commandes reÃ§ues (USDT ou Carte)') }}</h2>

    {% if orders %}
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 12px;">{{ _('Produit') }}</th>
                    <th>{{ _('Client') }}</th>
                    <th>{{ _('Vendeur') }}</th>
                    <th>{{ _('Prix â‚½') }}</th>
                    <th>{{ _('~ USDT') }}</th>
                    <th>ğŸ’° {{ _('Commission') }}</th>
                    <th>{{ _('Ã€ reverser') }}</th>
                    <th>ğŸ’¼ {{ _('Paiement vendeur') }}</th>
                    <th>ğŸ’³ {{ _('MÃ©thode') }}</th>
                    <th>ğŸ“Œ {{ _('Statut') }}</th>
                    <th>âœ… {{ _('Action') }}</th>
                    <th>ğŸ” {{ _('DÃ©tail') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                    {% for item in order.items %}
                        {% if item.listing %}
                            {% set prix_rub = item.unit_price * item.quantity %}
                            {% set prix_usdt = prix_rub / taux %}
                            {% set commission = item.commission %}
                            {% set reversement = prix_usdt - (commission / taux) %}
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px;">{{ item.listing.title }}</td>
                                <td>{{ order.buyer.username }}</td>
                                <td>{{ item.listing.user.username }}</td>
                                <td>{{ prix_rub | round(2) }}</td>
                                <td>{{ prix_usdt | round(2) }} USDT</td>
                                <td style="color: red;">-{{ (commission / taux) | round(2) }} USDT</td>
                                <td style="color: green;">{{ reversement | round(2) }} USDT</td>
                                <td>
                                    {% if order.payment_method == 'carte' %}
                                        <strong>ğŸ¦ {{ _('Banque') }} :</strong> {{ item.listing.user.bank_name or _('Non fourni') }}<br>
                                        <strong>ğŸ’³ {{ _('Carte') }} :</strong> {{ item.listing.user.card_number or _('Non fourni') }}<br>
                                        <strong>ğŸ‘¤ {{ _('Titulaire') }} :</strong> {{ item.listing.user.card_holder or _('Non fourni') }}
                                    {% else %}
                                        <strong>ğŸ’° {{ _('Adresse USDT') }} :</strong><br>
                                        <code>{{ item.listing.user.usdt_address or _('Non fournie') }}</code>
                                    {% endif %}
                                </td>
                                <td>{{ order.payment_method or 'USDT' }}</td>
                                <td>
                                    {% if order.status == 'paid' %}
                                        <span style="color: green; font-weight: bold;">âœ… {{ _('PayÃ©') }}</span>
                                    {% elif order.status == 'commission_payee' %}
                                        <span style="color: orange; font-weight: bold;">ğŸ•’ {{ _('Commission payÃ©e') }}</span>
                                    {% else %}
                                        <span style="color: gray;">â³ {{ _('En attente') }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if order.status != 'paid' %}
                                        <form method="POST" action="{% if order.payment_method == 'usdt' %}{{ url_for('admin.confirmer_paiement', order_id=order.id) }}{% else %}{{ url_for('confirmer_paiement', order_id=order.id) }}{% endif %}">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 6px;">
                                                âœ… {{ _('Marquer comme payÃ©') }}
                                            </button>
                                        </form>
                                    {% else %}
                                        âœ”ï¸
                                    {% endif %}
                                </td>

                                <td>
                                    <a href="{{ url_for('admin.admin_commande_detail', order_id=order.id) }}" style="background-color: #6c757d; color: white; padding: 6px 10px; border-radius: 6px; text-decoration: none;">
                                        ğŸ” {{ _('Voir') }}
                                    </a>
                                </td>
                            </tr>
                        {% else %}
                            <tr style="border-bottom: 1px solid #ddd; background-color: #fff3cd;">
                                <td colspan="12" style="padding: 12px; color: #856404;">
                                    âš ï¸ {{ _('Commande') }} #{{ order.id }} {{ _('liÃ©e Ã  une annonce supprimÃ©e.') }}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center;">{{ _('Aucune commande enregistrÃ©e.') }}</p>
    {% endif %}
</div>
{% endblock %}
