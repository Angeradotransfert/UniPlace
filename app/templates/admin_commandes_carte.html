{% extends "base.html" %}
{% block content %}

<div style="max-width: 1100px; margin: auto; padding: 40px 20px; font-family: 'Baloo 2', cursive;">
    <h2 style="text-align: center; font-size: 2.4rem; color: #2c3e50;">üí≥ {{ _('Commandes re√ßues (Carte bancaire)') }}</h2>

    {% if orders %}
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 12px;">{{ _('Produit') }}</th>
                    <th>{{ _('Client') }}</th>
                    <th>{{ _('Vendeur') }}</th>
                    <th>{{ _('Prix vendeur (‚ÇΩ)') }}</th>
                    <th>{{ _('Commission (10%)') }}</th>
                    <th>{{ _('Total pay√© (‚ÇΩ)') }}</th>
                    <th>{{ _('Statut') }}</th>
                    <th>{{ _('D√©tails') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                    {% for item in order.items %}
                        {% if item.listing %}
                            {% set prix_rub = item.unit_price * item.quantity %}
                            {% set commission = item.commission %}
                            {% set total = prix_rub + commission %}
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 10px;">{{ item.listing.title }}</td>
                                <td>{{ order.buyer.username }}</td>
                                <td>
                                    {{ item.listing.user.username }}<br>
                                    <small>
                                        <strong>üè¶ {{ _('Banque') }} :</strong> {{ item.listing.user.bank_name or _('Non fourni') }}<br>
                                        <strong>üí≥ {{ _('Carte') }} :</strong> {{ item.listing.user.card_number or _('Non fourni') }}<br>
                                        <strong>üë§ {{ _('Titulaire') }} :</strong> {{ item.listing.user.card_holder or _('Non fourni') }}
                                    </small>
                                </td>
                                <td>{{ prix_rub | round(2) }}</td>
                                <td style="color: red;">{{ commission | round(2) }} ‚ÇΩ</td>
                                <td style="color: green;"><strong>{{ total | round(2) }} ‚ÇΩ</strong></td>
                                <td>
                                    {% if order.status == 'paid' %}
                                        <span style="color: green; font-weight: bold;">‚úÖ {{ _('Pay√©') }}</span>
                                    {% else %}
                                        <form method="POST" action="{{ url_for('admin.confirmer_paiement_carte', order_id=order.id) }}">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" style="background-color: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px;">
                                                ‚úÖ {{ _('Confirmer') }}
                                            </button>
                                        </form>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('admin.admin_commande_detail', order_id=order.id) }}" style="background-color: #6c757d; color: white; padding: 6px 10px; border-radius: 6px; text-decoration: none;">
                                        üîç {{ _('Voir') }}
                                    </a>
                                </td>
                            </tr>
                        {% else %}
                            <tr style="border-bottom: 1px solid #ddd; background-color: #fff3cd;">
                                <td colspan="8" style="padding: 12px; color: #856404;">
                                    ‚ö†Ô∏è {{ _('Commande') }} #{{ order.id }} {{ _('li√©e √† une annonce supprim√©e.') }}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="text-align: center;">{{ _('Aucune commande par carte enregistr√©e.') }}</p>
    {% endif %}
</div>

{% endblock %}
