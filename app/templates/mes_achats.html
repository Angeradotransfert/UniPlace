{% extends "base.html" %}

{% block content %}
<div style="max-width: 1100px; margin: auto; padding: 40px 20px; font-family: 'Segoe UI', sans-serif;">
    <h2 style="text-align: center; font-size: 2.4rem; color: #2c3e50; margin-bottom: 30px;">{{ _('ğŸ›’ Historique de mes achats') }}</h2>

    {% if orders %}
        {% set displayed_vendors = [] %}
        {% for order in orders %}
            {% for item in order.items %}

            {% if item.listing %}
            <div style="background: #ffffff; border-left: 6px solid #28a745; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                <h3 style="color: #007BFF; margin-bottom: 10px;">
                    <a href="{{ url_for('listings.annonce_detail', listing_id=item.listing.id) }}" style="color: #007BFF; text-decoration: none;">
                        {{ item.listing.title }} ğŸ”—
                    </a>
                </h3>

                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    {% if item.listing.images and item.listing.images[0] %}
                        <a href="{{ url_for('listings.annonce_detail', listing_id=item.listing.id) }}">
                            <img src="{{ url_for('static', filename='uploads/' + item.listing.images[0].filename) }}"
                                 alt="Image du produit"
                                 style="max-width: 180px; max-height: 180px; width: auto; height: auto; border-radius: 10px; border: 1px solid #ccc;">
                        </a>
                    {% endif %}

                    <div style="flex: 1; min-width: 260px;">
                        <p><strong>{{ _('ğŸ’° Prix payÃ©') }} :</strong> <span style="color: #28a745;">{{ item.unit_price }} â‚½</span></p>
                        <p><strong>{{ _('ğŸ—“ Date d\'achat') }} :</strong> {{ order.timestamp.strftime('%d/%m/%Y Ã  %H:%M') }}</p>
                        <p><strong>{{ _('ğŸ‘¤ Vendeur') }} :</strong>
                            {% if item.listing.user %}
                                {{ item.listing.user.username }}
                            {% else %}
                                Vendeur inconnu
                            {% endif %}
                        </p>

                        {% if order.status == 'paid' and item.listing.user and item.listing.user.id not in displayed_vendors %}
                        <div style="margin-top: 15px; padding: 15px; border: 1px solid #ccc; border-radius: 10px; background-color: #f8f9fa;">
                            <h4 style="margin-bottom: 10px;">{{ _('ğŸ“ CoordonnÃ©es du vendeur') }}</h4>
                            {% if item.listing.user.usdt_address %}
                                <p><strong>{{ _('ğŸª™ Adresse USDT (TRC20)') }} :</strong> {{ item.listing.user.usdt_address }}</p>
                            {% endif %}
                            {% if item.listing.user.bank_name and item.listing.user.card_number and item.listing.user.card_holder %}
                                <p><strong>{{ _('ğŸ¦ Banque') }} :</strong> {{ item.listing.user.bank_name }}</p>
                                <p><strong>{{ _('ğŸ’³ NumÃ©ro carte') }}:</strong> {{ item.listing.user.card_number }}</p>
                                <p><strong>{{ _('ğŸ‘¤ Titulaire') }} :</strong> {{ item.listing.user.card_holder }}</p>
                            {% endif %}
                            <a href="{{ url_for('messaging.send_message', user_id=item.listing.user.id) }}"
                               style="display: inline-block; margin-top: 10px; padding: 8px 14px; background-color: #007BFF; color: white; border-radius: 8px; text-decoration: none;">
                               ğŸ“© {{ _('Contacter le vendeur') }}
                            </a>
                        </div>
                        {% do displayed_vendors.append(item.listing.user.id) %}
                        {% endif %}

                        <p><strong>{{ _('ğŸ“ Ville') }} :</strong> {{ item.listing.city }}</p>
                        <p><strong>{{ _('ğŸ“¦ CatÃ©gorie') }} :</strong> {{ item.listing.category }} â€“ {{ item.listing.subcategory }}</p>

                        <p><strong>{{ _('ğŸ’³ Paiement') }} :</strong>
                            {% if order.payment_method == 'usdt' %}
                                ğŸ’¸ {{ _('USDT') }}
                            {% elif order.payment_method == 'carte' %}
                                ğŸ’³  {{ _('Carte bancaire') }}
                            {% else %}
                                â“ {{ _('Inconnu') }}
                            {% endif %}
                        </p>

                        <p><strong>{{ _('ğŸ“Œ Statut') }} :</strong>
                            <span style="color: {% if order.status == 'paid' or order.status == 'commission_payee' %}green{% else %}orange{% endif %}; font-weight: bold;">
                                {% if order.status == 'paid' %}
                                    âœ… {{ _('Paiement confirmÃ©') }}
                                {% elif order.status == 'commission_payee' %}
                                    ğŸ’³ {{ _('Commission payÃ©e') }}
                                {% else %}
                                    ğŸ•’ {{ _('En attente') }}
                                {% endif %}
                            </span>
                        </p>

                        <p><strong>{{ _('ğŸšš MÃ©thode de livraison') }} :</strong>
                            {% if order.delivery_method == 'pochta' %}
                                ğŸ“¦ {{ _('Pochta Rossii') }}
                            {% elif order.delivery_method == 'main_propre' %}
                                ğŸ¤ {{ _('Remise en main propre') }}
                            {% else %}
                                {{ _('Non spÃ©cifiÃ©e') }}
                            {% endif %}
                        </p>

                        <p><strong>{{ _('ğŸ  Adresse') }}  :</strong> {{ order.delivery_address or _('Non renseignÃ©e') }}</p>

                        {% if order.tracking_number %}
                            <p><strong>{{ _('ğŸ–Ÿ Suivi colis') }}:</strong> {{ order.tracking_number }}</p>
                            <p><strong>{{ _('ğŸ“¦ Statut livraison') }}:</strong> {{ order.tracking_status or 'En cours' }}</p>
                        {% endif %}

                        {% if order.status == 'en_attente' %}
                        <form action="{{ url_for('main.annuler_commande', order_id=order.id) }}" method="POST" style="margin-top: 15px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit"
                                    style="background-color: #dc3545; color: white; border: none; padding: 10px 18px; border-radius: 8px; font-size: 15px; cursor: pointer;">
                                âŒ {{ _('Annuler la commande') }}
                            </button>
                        </form>
                        {% endif %}

                        {% if (order.status == 'paid' or order.status == 'commission_payee') and not order.review %}
                        <form action="{{ url_for('listings.laisser_avis', order_id=order.id) }}" method="POST" style="margin-top: 20px;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <label><strong>â­ {{ _('Noter ce produit') }} :</strong></label><br>
                            <select name="rating" required style="margin-top: 6px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
                                <option value="">-- {{ _('-- Choisissez une note --') }} --</option>
                                {% for i in range(1, 6) %}
                                    <option value="{{ i }}">{{ i }} Ã©toile{{ 's' if i > 1 }}</option>
                                {% endfor %}
                            </select>

                            <label style="margin-top: 10px;"><strong>ğŸ’¬ {{ _('Commentaire') }} :</strong></label><br>
                            <textarea name="comment" rows="2" placeholder="{{ _('Votre avis sur le produit...') }}" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc;"></textarea>

                            <button type="submit" style="margin-top: 10px; background-color: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 8px;">
                                âœ… {{ _('Laisser un avis') }}
                            </button>
                        </form>
                        {% elif order.review %}
                        <p style="margin-top: 20px; color: #007BFF;"><strong>âœ”ï¸ {{ _('Vous avez dÃ©jÃ  laissÃ© un avis.') }}</strong></p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% else %}
            <div style="background: #fff3cd; border-left: 6px solid #ffc107; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                <p style="color: #856404; font-weight: bold;">âš ï¸ {{ _('Cette annonce a Ã©tÃ© supprimÃ©e ou n\'existe plus.') }}</p>
            </div>
            {% endif %}

            {% endfor %}
        {% endfor %}
    {% else %}
        <p style="text-align: center; font-size: 1.2rem; color: #555;">{{ _("Vous n'avez encore rien achetÃ©. ğŸ˜•") }}</p>
    {% endif %}
</div>
{% endblock %}
